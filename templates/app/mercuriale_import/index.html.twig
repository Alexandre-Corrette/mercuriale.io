{% extends 'base.html.twig' %}

{% block title %}Import Mercuriale - Mercuriale.io{% endblock %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br from-cream to-cream-dark py-8 px-4">
    <div class="max-w-3xl mx-auto">
        {# Header #}
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-navy mb-2">
                <i class="fas fa-file-import mr-2"></i>Import de mercuriale
            </h1>
            <p class="text-gray-500">Importez vos prix fournisseurs depuis un fichier CSV ou Excel</p>
        </div>

        {# Card #}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-6 md:p-8">
                {# Flash messages #}
                {% for flash_message in app.flashes('error') %}
                    <div class="flex items-center gap-3 p-4 mb-4 bg-red-50 text-red-800 border border-red-200 rounded-xl">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>{{ flash_message }}</span>
                    </div>
                {% endfor %}

                {% for flash_message in app.flashes('success') %}
                    <div class="flex items-center gap-3 p-4 mb-4 bg-green-50 text-green-800 border border-green-200 rounded-xl">
                        <i class="fas fa-check-circle"></i>
                        <span>{{ flash_message }}</span>
                    </div>
                {% endfor %}

                {% for flash_message in app.flashes('warning') %}
                    <div class="flex items-center gap-3 p-4 mb-4 bg-amber-50 text-amber-800 border border-amber-200 rounded-xl">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>{{ flash_message }}</span>
                    </div>
                {% endfor %}

                {{ form_start(form, {'attr': {'id': 'upload-form', 'novalidate': 'novalidate'}}) }}

                    {# Fournisseur select #}
                    <div class="mb-6">
                        <label class="block font-semibold text-gray-700 mb-2">
                            <i class="fas fa-truck mr-2"></i>Fournisseur
                        </label>
                        {{ form_widget(form.fournisseur, {'attr': {
                            'class': 'w-full px-4 py-3 text-base border-2 border-gray-200 rounded-xl bg-white focus:outline-none focus:border-coral focus:ring-4 focus:ring-coral/10 transition-all'
                        }}) }}
                        {{ form_errors(form.fournisseur) }}
                    </div>

                    {# Etablissement select #}
                    <div class="mb-6">
                        <label class="block font-semibold text-gray-700 mb-2">
                            <i class="fas fa-building mr-2"></i>Etablissement (optionnel)
                        </label>
                        {{ form_widget(form.etablissement, {'attr': {
                            'class': 'w-full px-4 py-3 text-base border-2 border-gray-200 rounded-xl bg-white focus:outline-none focus:border-coral focus:ring-4 focus:ring-coral/10 transition-all'
                        }}) }}
                        <p class="mt-2 text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            Laissez vide pour appliquer les prix a tous les etablissements du groupe
                        </p>
                        {{ form_errors(form.etablissement) }}
                    </div>

                    {# File input #}
                    <div class="mb-6">
                        <label class="block font-semibold text-gray-700 mb-2">
                            <i class="fas fa-file-excel mr-2"></i>Fichier mercuriale
                        </label>

                        <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center cursor-pointer bg-gray-50 transition-all duration-300 hover:border-coral hover:bg-coral/10">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-navy to-navy-light rounded-full flex items-center justify-center">
                                <i class="fas fa-cloud-upload-alt text-2xl text-white"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Glissez votre fichier ici</h3>
                            <p class="text-gray-500 mb-4">ou cliquez pour parcourir</p>
                            <div class="px-4 py-2 bg-cream-dark rounded-lg text-sm text-gray-500 inline-block">
                                <i class="fas fa-info-circle mr-1 text-gold"></i>
                                CSV ou XLSX - Maximum 10 Mo - 5000 lignes max
                            </div>
                        </div>

                        <div id="file-preview" class="hidden mt-4 p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-excel text-xl text-green-600"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div id="file-name" class="font-semibold text-gray-900 truncate"></div>
                                    <div id="file-size" class="text-sm text-gray-500"></div>
                                </div>
                                <button type="button" id="remove-file" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg text-gray-500 hover:bg-red-100 hover:text-red-600 transition-all">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        {{ form_widget(form.file, {'attr': {'id': 'file-input', 'class': 'hidden'}}) }}
                        {{ form_errors(form.file) }}
                    </div>

                    {# Submit button #}
                    <button type="submit" id="submit-btn" disabled class="w-full px-8 py-4 text-lg font-semibold text-white bg-gradient-to-r from-navy to-navy-light rounded-xl flex items-center justify-center gap-3 transition-all duration-300 hover:translate-y-[-2px] hover:shadow-xl hover:shadow-navy/30 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                        <i class="fas fa-upload text-xl"></i>
                        Analyser le fichier
                    </button>

                {{ form_end(form) }}
            </div>
        </div>

        {# Pending imports #}
        {% if pendingImports is not empty %}
        <div class="mt-8 bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-6">
                <h2 class="text-lg font-bold text-navy mb-4">
                    <i class="fas fa-clock mr-2"></i>Imports en cours
                </h2>
                <div class="space-y-3">
                    {% for import in pendingImports %}
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                        <div>
                            <div class="font-semibold text-gray-900">{{ import.originalFilename }}</div>
                            <div class="text-sm text-gray-500">
                                {{ import.fournisseur.nom }} - {{ import.totalRows }} lignes
                                <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-{{ import.status.color }}-100 text-{{ import.status.color }}-800">
                                    {{ import.status.label }}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <a href="{{ path('app_mercuriale_import_mapping', {importId: import.idAsString}) }}" class="px-4 py-2 bg-coral text-white rounded-lg hover:bg-coral-dark transition-colors">
                                <i class="fas fa-arrow-right mr-1"></i>Continuer
                            </a>
                            <form action="{{ path('app_mercuriale_import_cancel', {importId: import.idAsString}) }}" method="post" class="inline">
                                <input type="hidden" name="_token" value="{{ csrf_token('cancel_import_' ~ import.idAsString) }}">
                                <button type="submit" class="px-3 py-2 text-gray-500 hover:text-red-600 transition-colors" onclick="return confirm('Annuler cet import ?')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {# Back link #}
        <div class="text-center mt-6">
            <a href="{{ path('admin') }}" class="inline-flex items-center gap-2 text-gray-500 text-sm hover:text-coral transition-colors">
                <i class="fas fa-arrow-left"></i>
                Retour au tableau de bord
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const uploadForm = document.getElementById('upload-form');
    const fileInput = uploadForm.querySelector('input[type="file"]');
    const submitBtn = document.getElementById('submit-btn');
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFile = document.getElementById('remove-file');

    if (!fileInput) {
        console.error('File input not found');
        return;
    }

    const maxFileSize = 10 * 1024 * 1024;
    const allowedExtensions = ['csv', 'xlsx'];

    // Drop zone click
    dropZone.addEventListener('click', () => fileInput.click());

    // Drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('border-coral', 'bg-coral/10');
            dropZone.classList.remove('border-gray-300', 'bg-gray-50');
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('border-coral', 'bg-coral/10');
            dropZone.classList.add('border-gray-300', 'bg-gray-50');
        });
    });

    // Handle dropped files
    dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // Handle selected files
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            handleFile(fileInput.files[0]);
        }
    });

    // Remove file
    removeFile.addEventListener('click', () => {
        fileInput.value = '';
        updateUI(null);
    });

    function handleFile(file) {
        const ext = file.name.split('.').pop().toLowerCase();

        if (!allowedExtensions.includes(ext)) {
            alert('Format non supporte. Utilisez un fichier CSV ou XLSX.');
            return;
        }

        if (file.size > maxFileSize) {
            alert('Fichier trop volumineux (maximum 10 Mo).');
            return;
        }

        // Update file input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        updateUI(file);
    }

    function updateUI(file) {
        if (file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            filePreview.classList.remove('hidden');
            dropZone.classList.add('hidden');
            submitBtn.disabled = false;
        } else {
            filePreview.classList.add('hidden');
            dropZone.classList.remove('hidden');
            submitBtn.disabled = true;
        }
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' o';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' Ko';
        return (bytes / (1024 * 1024)).toFixed(2) + ' Mo';
    }

    // Form submit
    uploadForm.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse en cours...';
    });
});
</script>
{% endblock %}
